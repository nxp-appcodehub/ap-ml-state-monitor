Overview
========

This applicatoin provides a preview of MPP (Multimedia Processing Pipleine)
library for MCU with time series support for Fxls8974 accelerometer.

The application showcase ML-Based System State Monitoring for fan state detection supporting LPC55S69 and i.MXRT1170 NXP MCUs.
The application provides four Neural Network models (CNN, Light CNN, MLP, Light ResNet)
with various performance using TensorFlow Lite for Microcontrollers and Glow inference engines.


Pipelines Description
=====================

The applicaiton supports two pipeline configuration:

- Fxls8974 accelerometer (with real time or static data) and
inference components to detect fan system state using Neural Networks


```
+-------------------------+      +---------------+
|                         |      |               |
|                         |      |               |
|      Accelerometer      | -->  |   Inferance   | 
| Fxls8974 or static data |      |               |
|                         |      |               |
+-------------------------+      +---------------+
```

- Fxls8974 accelerometer and SD card component to colect data for
training Neural Networks models
```
+-------------------------+      +---------------+
|                         |      |               |
|                         |      |               |
|      Accelerometer      | -->  |    SD card    | 
| Fxls8974 or static data |      |               |
|                         |      |               |
+-------------------------+      +---------------+
```


MPP API
=======

The MPP (Multimedia Processing Pipleine) preview library with time series support
is built ont top of [MPP eIQ release](https://github.com/nxp-mcuxpresso/mcux-sdk-middleware-eiq/tree/MCUX_2.13.0/mpp).

The preview library located in eiq/mpp folder extends the pipeline API with the following
functions documented in mpp_api.h:

	int mpp_accelerometer_add(...)
	int mpp_static_accelerometer_add(...)
	int mpp_sd_add(...)

The library provides source code for drivers in eiq/mpp/hal folder.


How to change user configurations
=================================

This application supports the following configurations documented in app_config.h:

- `SENSOR_COLLECT_LOG_EXT`: chose between running Inference or logging data on SD card

- `SOURCE_STATIC_ACCEL_DATA` | `STATIC_ACCEL_VDSET`: chose between Fxls8974 sensor or static data input for validation

- `SELECTED_MODEL` | `MODEL_QUANTIZED`: chose the Neural Network model to use and quantization (8-bit int or 32-bit float)

- `INFERENCE_ENGINE`: chose between FT Lite Micro and Glow inference engines

- `PRINT_SENSOR_DATA`: print the sensor data on the console for debugging

The application is optimized for memory usage and includes only one processing element
(inference engine or SD card) and one validation dataset at a time. 


How to update Neural Network models
===================================

The Neural Network models are provided in an associated Jupyter Notebook script.
The script saves the trained models in TensorFlow Lite format and converts them to
source and object files for Glow and TensorFlow Lite for Microcontrollers
inference engines.

To update the models into the project, replace the source files from source/models/tensorflow
and source/models/glow folders.
For Glow also update the object file of the selected model in the project configuration.
The data normalization parameters generated by the script in model_configuration.c
file should be update in source/models folder.


Hardware requirements
=====================

- Personal Computer
- LPC55S69-EVK or MIMXRT1170-EVK board
- Mini/micro USB cable

Optional (fan detection with real-time data from Fxls8974):
- FRDM-STBI-A8974 sensor shield board
- Arduino ProtoShield + 5V DC Fan

Optional (loging fan vibration data from Fxls8974 for NN model training)
- SD card


Board settings
==============

The following configuration must be used to setup the FRDM-STBI-A8974 sensor shield board:
- SW1 Pins 2-3 should be connected to enable "ACCEL NORMAL" mode
- SH38 shunt (near SW1) should be cut/open to keep "ACCEL NORMAL" mode (optional for LPC55S69-EVK, mandatory for  MIMXRT1170-EVK)
- SW2 Pins 2-3 should be connected to enable I2C
- For LPC55S69-EVK: Pins 1-2 of Jumpers J7 and J8 should be connected to enable I2C0
- For MIMXRT1170-EVK: Pins 2-3 of Jumpers J7 and J8 should be connected to enable I2C1

The following configuration must be used to connect the sensor shield and the fan to the evaluation kit (LPC55S69-EVK or MIMXRT1170-EVK):
- Connect the FRDM-STBI-A8974(J3, J4, J5, J6) to the Arduino connector of the evaluation kit LPC55S69-EVK(P18, P19, P17, P16) or MIMXRT1170-EVK(J9, J26, J10, J25)
- *Optional* Connect the Arduino ProtoShield to the Arduino connector of the FRDM-STBI-A8974(J3, J4, J5, J6)
- Connect the DC Fan to the 5V port of the Arduino ProtoShield or directly to the FRDM-STBI-A8974(J6.5-5V, J6.6-GND)

Prepare the Demo
================

1.  Connect a USB cable between the host PC and the OpenSDA USB port on the target board. 
2.  Open a serial terminal with the following settings:
    - 115200 baud rate
    - 8 data bits
    - No parity
    - One stop bit
    - No flow control
3.  Download the program to the target board.
4.  Either press the reset button on your board or launch the debugger in your IDE to begin running the demo.

> *Note!* For maximum performance use the **Release Build Configuration** profile in MCUXpresso IDE.

Running the demo
================
```
Starting Application:
        Application version: 1.0.0
        MPP version: MPP_VERSION_1.0.0
        Inference Engine: TensorFlow-Lite Micro
----------------------------------------
     Inference time: 13 ms
     Detected: FAN-OFF (99)
----------------------------------------
----------------------------------------
     Inference time: 13 ms
     Detected: FAN-ON (87)
----------------------------------------
```
